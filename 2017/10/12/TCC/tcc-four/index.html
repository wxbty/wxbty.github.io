<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="为往圣继绝学！"><title>tcc源码解析系列(四)之项目实战 | 兰陵笑笑生</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">tcc源码解析系列(四)之项目实战</h1><a id="logo" href="/.">兰陵笑笑生</a><p class="description">为往圣继绝学！</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">tcc源码解析系列(四)之项目实战</h1><div class="post-meta">Oct 12, 2017<span> | </span><span class="category"><a href="/categories/hmily-tcc/">hmily-tcc</a></span></div><div class="post-content"><h4 id="通过之前的几篇文章我相信您已经搭建好了运行环境，本次的项目实战是依照hmily-tcc-demo项目来演练，也是非常经典的分布式事务场景：支付成功，进行订单状态的更新，扣除用户账户，库存扣减这几个模块来进行tcc分布式事务。话不多说，让我们一起进入体验吧！"><a href="#通过之前的几篇文章我相信您已经搭建好了运行环境，本次的项目实战是依照hmily-tcc-demo项目来演练，也是非常经典的分布式事务场景：支付成功，进行订单状态的更新，扣除用户账户，库存扣减这几个模块来进行tcc分布式事务。话不多说，让我们一起进入体验吧！" class="headerlink" title="通过之前的几篇文章我相信您已经搭建好了运行环境，本次的项目实战是依照hmily-tcc-demo项目来演练，也是非常经典的分布式事务场景：支付成功，进行订单状态的更新，扣除用户账户，库存扣减这几个模块来进行tcc分布式事务。话不多说，让我们一起进入体验吧！"></a>通过之前的几篇文章我相信您已经搭建好了运行环境，本次的项目实战是依照<a href="https://github.com/yu199195/hmily/tree/master/hmily-tcc-demo" target="_blank" rel="external">hmily-tcc-demo</a>项目来演练，也是非常经典的分布式事务场景：支付成功，进行订单状态的更新，扣除用户账户，库存扣减这几个模块来进行tcc分布式事务。话不多说，让我们一起进入体验吧！</h4><ul>
<li>首先我们找到 <strong>PaymentServiceImpl.makePayment</strong> 方法，这是tcc分布式事务的发起者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//tcc分布式事务的发起者</span></div><div class="line"><span class="meta">@Tcc</span>(confirmMethod = <span class="string">"confirmOrderStatus"</span>, cancelMethod = <span class="string">"cancelOrderStatus"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePayment</span><span class="params">(Order order)</span> </span>&#123;</div><div class="line">    order.setStatus(OrderStatusEnum.PAYING.getCode());</div><div class="line">    orderMapper.update(order);</div><div class="line">    <span class="comment">//扣除用户余额 远端的rpc调用</span></div><div class="line">    AccountDTO accountDTO = <span class="keyword">new</span> AccountDTO();</div><div class="line">    accountDTO.setAmount(order.getTotalAmount());</div><div class="line">    accountDTO.setUserId(order.getUserId());</div><div class="line">    accountService.payment(accountDTO);</div><div class="line">    <span class="comment">//进入扣减库存操作 远端的rpc调用</span></div><div class="line">    InventoryDTO inventoryDTO = <span class="keyword">new</span> InventoryDTO();</div><div class="line">    inventoryDTO.setCount(order.getCount());</div><div class="line">    inventoryDTO.setProductId(order.getProductId());</div><div class="line">    inventoryService.decrease(inventoryDTO);</div><div class="line">&#125;</div><div class="line"><span class="comment">//更新订单的confirm方法</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirmOrderStatus</span><span class="params">(Order order)</span> </span>&#123;</div><div class="line">     order.setStatus(OrderStatusEnum.PAY_SUCCESS.getCode());</div><div class="line">     orderMapper.update(order);</div><div class="line">     LOGGER.info(<span class="string">"=========进行订单confirm操作完成================"</span>);</div><div class="line"></div><div class="line"></div><div class="line"> &#125;</div><div class="line"> <span class="comment">//更新订单的cancel方法</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelOrderStatus</span><span class="params">(Order order)</span> </span>&#123;</div><div class="line">     order.setStatus(OrderStatusEnum.PAY_FAIL.getCode());</div><div class="line">     orderMapper.update(order);</div><div class="line">     LOGGER.info(<span class="string">"=========进行订单cancel操作完成================"</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>makePayment 方法是tcc分布式事务的发起者，它里面有更新订单状态（本地），进行库存扣减（rpc扣减），资金扣减(rpc调用)</p>
</li>
<li><p><strong>confirmOrderStatus</strong> 为订单状态confirm方法，<strong>cancelOrderStatus</strong> 为订单状态cancel方法。</p>
</li>
<li><p>我们重点关注 <strong>@Tcc(confirmMethod = “confirmOrderStatus”, cancelMethod = “cancelOrderStatus”)</strong> 这个注解，为什么加了这个注解就有神奇的作用。</p>
</li>
</ul>
<h3 id="Tcc注解切面"><a href="#Tcc注解切面" class="headerlink" title="@Tcc注解切面"></a>@Tcc注解切面</h3><ul>
<li>我们找到在<a href="https://github.com/yu199195/hmily/tree/master/hmily-tcc-core" target="_blank" rel="external">hmily-tcc-core</a>包中找到<br><strong>TccTransactionAspect</strong>，这里定义@Tcc的切点。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TccTransactionAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> TccTransactionInterceptor tccTransactionInterceptor;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTccTransactionInterceptor</span><span class="params">(TccTransactionInterceptor tccTransactionInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.tccTransactionInterceptor = tccTransactionInterceptor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.hmily.tcc.annotation.Tcc)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">txTransactionInterceptor</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"txTransactionInterceptor()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">return</span> tccTransactionInterceptor.interceptor(proceedingJoinPoint);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>我们可以知道Spring实现类的方法凡是加了@Tcc注解的，在调用的时候，都会进行 <strong>tccTransactionInterceptor.interceptor</strong> 调用。</p>
</li>
<li><p>其次我们发现该类是一个抽象类，肯定会有其他类继承它，你猜的没错，对应dubbo用户，他的继承类为:</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboTccTransactionAspect</span> <span class="keyword">extends</span> <span class="title">TccTransactionAspect</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboTccTransactionAspect</span><span class="params">(DubboTccTransactionInterceptor dubboTccTransactionInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.setTccTransactionInterceptor(dubboTccTransactionInterceptor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Ordered.HIGHEST_PRECEDENCE;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>springcloud的用户,它的继承类为:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudTccTransactionAspect</span> <span class="keyword">extends</span> <span class="title">TccTransactionAspect</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringCloudTxTransactionAspect</span><span class="params">(SpringCloudTccTransactionAspect  springCloudTccTransactionAspect)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setTccTransactionInterceptor(springCloudTccTransactionAspect);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Ordered.HIGHEST_PRECEDENCE;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>我们注意到他们都实现了Spring的Ordered接口，并重写了 <strong>getOrder</strong> 方法，都返回了 <strong>Ordered.HIGHEST_PRECEDENCE</strong> 那么可以知道，他是优先级最高的切面。</li>
</ul>
<h3 id="TccCoordinatorMethodAspect-切面"><a href="#TccCoordinatorMethodAspect-切面" class="headerlink" title="TccCoordinatorMethodAspect 切面"></a>TccCoordinatorMethodAspect 切面</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccCoordinatorMethodAspect</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TccCoordinatorMethodInterceptor tccCoordinatorMethodInterceptor;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TccCoordinatorMethodAspect</span><span class="params">(TccCoordinatorMethodInterceptor tccCoordinatorMethodInterceptor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.tccCoordinatorMethodInterceptor = tccCoordinatorMethodInterceptor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.hmily.tcc.annotation.Tcc)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">coordinatorMethod</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Around</span>(<span class="string">"coordinatorMethod()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">return</span> tccCoordinatorMethodInterceptor.interceptor(proceedingJoinPoint);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Ordered.HIGHEST_PRECEDENCE + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>该切面是第二优先级的切面，意思就是当我们对有@Tcc注解的方法发起调用的时候，首先会进入 <strong>TccTransactionAspect</strong> 切面，然后再进入 <strong>TccCoordinatorMethodAspect</strong> 切面。<br>该切面主要是用来获取@Tcc注解上的元数据，比如confrim方法名称等等。</p>
</li>
<li><p>到这里如果大家基本能明白的话，差不多就了解了整个框架原理，现在让我们来跟踪调用吧。</p>
</li>
</ul>
<h3 id="现在我们回过头，我们来调用-PaymentServiceImpl-makePayment-方法"><a href="#现在我们回过头，我们来调用-PaymentServiceImpl-makePayment-方法" class="headerlink" title="现在我们回过头，我们来调用 PaymentServiceImpl.makePayment 方法"></a>现在我们回过头，我们来调用 <strong>PaymentServiceImpl.makePayment</strong> 方法</h3><ul>
<li>dubbo用户，我们会进入如下拦截器:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboTccTransactionInterceptor</span> <span class="keyword">implements</span> <span class="title">TccTransactionInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TccTransactionAspectService tccTransactionAspectService;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboTccTransactionInterceptor</span><span class="params">(TccTransactionAspectService tccTransactionAspectService)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.tccTransactionAspectService = tccTransactionAspectService;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptor</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">final</span> String context = RpcContext.getContext().getAttachment(Constant.TCC_TRANSACTION_CONTEXT);</div><div class="line">        TccTransactionContext tccTransactionContext = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNoneBlank(context)) &#123;</div><div class="line">            tccTransactionContext =</div><div class="line">                    GsonUtils.getInstance().fromJson(context, TccTransactionContext.class);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> tccTransactionAspectService.invoke(tccTransactionContext, pjp);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>我们继续跟踪 <strong>tccTransactionAspectService.invoke(tccTransactionContext, pjp)</strong> ,发现通过判断过后，我们会进入 <strong>StartTccTransactionHandler.handler</strong> 方法,我们已经进入了分布式事务处理的入口了！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * 分布式事务处理接口</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> point   point 切点</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> context 信息</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> Object</span></div><div class="line"><span class="comment">    * <span class="doctag">@throws</span> Throwable 异常</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">handler</span><span class="params">(ProceedingJoinPoint point, TccTransactionContext context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">       Object returnValue;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">//开启分布式事务</span></div><div class="line">           tccTransactionManager.begin();</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">//发起调用 执行try方法</span></div><div class="line">               returnValue = point.proceed();</div><div class="line"></div><div class="line">           &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">               <span class="comment">//异常执行cancel</span></div><div class="line"></div><div class="line">               tccTransactionManager.cancel();</div><div class="line"></div><div class="line">               <span class="keyword">throw</span> throwable;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//try成功执行confirm confirm 失败的话，那就只能走本地补偿</span></div><div class="line">           tccTransactionManager.confirm();</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           tccTransactionManager.remove();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> returnValue;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>我们进行跟进 <strong>tccTransactionManager.begin()</strong> 方法:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * 该方法为发起方第一次调用</span></div><div class="line"><span class="comment">    * 也是tcc事务的入口</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</div><div class="line">       LogUtil.debug(LOGGER, () -&gt; <span class="string">"开始执行tcc事务！start"</span>);</div><div class="line">       TccTransaction tccTransaction = CURRENT.get();</div><div class="line">       <span class="keyword">if</span> (Objects.isNull(tccTransaction)) &#123;</div><div class="line">           tccTransaction = <span class="keyword">new</span> TccTransaction();</div><div class="line">           tccTransaction.setStatus(TccActionEnum.TRYING.getCode());</div><div class="line">           tccTransaction.setRole(TccRoleEnum.START.getCode());</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//保存当前事务信息</span></div><div class="line">       coordinatorCommand.execute(<span class="keyword">new</span> CoordinatorAction(CoordinatorActionEnum.SAVE, tccTransaction));</div><div class="line"></div><div class="line">       CURRENT.set(tccTransaction);</div><div class="line"></div><div class="line">       <span class="comment">//设置tcc事务上下文，这个类会传递给远端</span></div><div class="line">       TccTransactionContext context = <span class="keyword">new</span> TccTransactionContext();</div><div class="line">       context.setAction(TccActionEnum.TRYING.getCode());<span class="comment">//设置执行动作为try</span></div><div class="line">       context.setTransId(tccTransaction.getTransId());<span class="comment">//设置事务id</span></div><div class="line">       TransactionContextLocal.getInstance().set(context);</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>这里我们保存了事务信息，并且开启了事务上下文，并把它保存在了ThreadLoacl里面，大家想想这里为什么一定要保存在ThreadLocal里面。</p>
</li>
<li><p>begin方法执行完后，我们回到切面，现在我们来执行 <strong>point.proceed()</strong>，当执行这一句代码的时候，会进入第二个切面，即进入了 <strong>TccCoordinatorMethodInterceptor</strong></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">interceptor</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">final</span> TccTransaction currentTransaction = tccTransactionManager.getCurrentTransaction();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (Objects.nonNull(currentTransaction)) &#123;</div><div class="line">           <span class="keyword">final</span> TccActionEnum action = TccActionEnum.acquireByCode(currentTransaction.getStatus());</div><div class="line">           <span class="keyword">switch</span> (action) &#123;</div><div class="line">               <span class="keyword">case</span> TRYING:</div><div class="line">                   registerParticipant(pjp, currentTransaction.getTransId());</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> CONFIRMING:</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> CANCELING:</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> pjp.proceed(pjp.getArgs());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>这里由于是在try阶段，直接就进入了 <strong>registerParticipant</strong> 方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerParticipant</span><span class="params">(ProceedingJoinPoint point, String transId)</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</div><div class="line"></div><div class="line">        MethodSignature signature = (MethodSignature) point.getSignature();</div><div class="line">        Method method = signature.getMethod();</div><div class="line"></div><div class="line">        Class&lt;?&gt; clazz = point.getTarget().getClass();</div><div class="line"></div><div class="line">        Object[] args = point.getArgs();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Tcc tcc = method.getAnnotation(Tcc.class);</div><div class="line"></div><div class="line">        <span class="comment">//获取协调方法</span></div><div class="line">        String confirmMethodName = tcc.confirmMethod();</div><div class="line"></div><div class="line">       <span class="comment">/* if (StringUtils.isBlank(confirmMethodName)) &#123;</span></div><div class="line"><span class="comment">            confirmMethodName = method.getName();</span></div><div class="line"><span class="comment">        &#125;*/</span></div><div class="line"></div><div class="line">        String cancelMethodName = tcc.cancelMethod();</div><div class="line"></div><div class="line">       <span class="comment">/* if (StringUtils.isBlank(cancelMethodName)) &#123;</span></div><div class="line"><span class="comment">            cancelMethodName = method.getName();</span></div><div class="line"><span class="comment">        &#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="comment">//设置模式</span></div><div class="line">        <span class="keyword">final</span> TccPatternEnum pattern = tcc.pattern();</div><div class="line"></div><div class="line">        tccTransactionManager.getCurrentTransaction().setPattern(pattern.getCode());</div><div class="line"></div><div class="line"></div><div class="line">        TccInvocation confirmInvocation = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNoneBlank(confirmMethodName)) &#123;</div><div class="line">            confirmInvocation = <span class="keyword">new</span> TccInvocation(clazz,</div><div class="line">                    confirmMethodName, method.getParameterTypes(), args);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        TccInvocation cancelInvocation = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNoneBlank(cancelMethodName)) &#123;</div><div class="line">            cancelInvocation = <span class="keyword">new</span> TccInvocation(clazz,</div><div class="line">                    cancelMethodName,</div><div class="line">                    method.getParameterTypes(), args);</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//封装调用点</span></div><div class="line">        <span class="keyword">final</span> Participant participant = <span class="keyword">new</span> Participant(</div><div class="line">                transId,</div><div class="line">                confirmInvocation,</div><div class="line">                cancelInvocation);</div><div class="line"></div><div class="line">        tccTransactionManager.enlistParticipant(participant);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>这里就获取了 <strong>@Tcc(confirmMethod = “confirmOrderStatus”, cancelMethod = “cancelOrderStatus”)</strong><br>的信息，并把他封装成了 Participant，存起来，然后真正的调用 <strong>PaymentServiceImpl.makePayment</strong> 业务方法，在业务方法里面，我们首先执行的是更新订单状态（相信现在你还记得0.0）:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">order.setStatus(OrderStatusEnum.PAYING.getCode());</div><div class="line">orderMapper.update(order);</div></pre></td></tr></table></figure>
<ul>
<li>接下来，我们进行扣除用户余额,注意扣除余额这里是一个rpc方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">AccountDTO accountDTO = <span class="keyword">new</span> AccountDTO();</div><div class="line">accountDTO.setAmount(order.getTotalAmount());</div><div class="line">accountDTO.setUserId(order.getUserId());</div><div class="line">accountService.payment(accountDTO)</div></pre></td></tr></table></figure>
<ul>
<li>现在我们来关注 <strong>accountService.payment(accountDTO)</strong> ，这个接口的定义。</li>
</ul>
<h4 id="dubbo接口"><a href="#dubbo接口" class="headerlink" title="dubbo接口:"></a>dubbo接口:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountService</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 扣款支付</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> accountDTO 参数dto</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> true</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Tcc</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">payment</span><span class="params">(AccountDTO accountDTO)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="springcloud接口"><a href="#springcloud接口" class="headerlink" title="springcloud接口"></a>springcloud接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"account-service"</span>, configuration = MyConfiguration.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/account-service/account/payment"</span>)</div><div class="line">    <span class="meta">@Tcc</span></div><div class="line">    <span class="function">Boolean <span class="title">payment</span><span class="params">(@RequestBody AccountDTO accountDO)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="很明显这里我们都在接口上加了-Tcc注解，我们知道springAop的特性，在接口上加注解，是无法进入切面的，所以我们在这里，要采用rpc框架的某些特性来帮助我们获取到-Tcc注解信息。-这一步很重要。当我们发起"><a href="#很明显这里我们都在接口上加了-Tcc注解，我们知道springAop的特性，在接口上加注解，是无法进入切面的，所以我们在这里，要采用rpc框架的某些特性来帮助我们获取到-Tcc注解信息。-这一步很重要。当我们发起" class="headerlink" title="很明显这里我们都在接口上加了@Tcc注解，我们知道springAop的特性，在接口上加注解，是无法进入切面的，所以我们在这里，要采用rpc框架的某些特性来帮助我们获取到 @Tcc注解信息。 这一步很重要。当我们发起"></a>很明显这里我们都在接口上加了@Tcc注解，我们知道springAop的特性，在接口上加注解，是无法进入切面的，所以我们在这里，要采用rpc框架的某些特性来帮助我们获取到 @Tcc注解信息。 这一步很重要。当我们发起</h3><p><strong>accountService.payment(accountDTO)</strong> 调用的时候:</p>
<ul>
<li>dubbo用户，会走dubbo的filter接口,<strong>TccTransactionFilter</strong>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerParticipant</span><span class="params">(Class clazz, String methodName, Object[] arguments, Class... args)</span> <span class="keyword">throws</span> TccRuntimeException </span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Method method = clazz.getDeclaredMethod(methodName, args);</div><div class="line">          Tcc tcc = method.getAnnotation(Tcc.class);</div><div class="line">          <span class="keyword">if</span> (Objects.nonNull(tcc)) &#123;</div><div class="line"></div><div class="line">            <span class="comment">//获取事务的上下文</span></div><div class="line">              <span class="keyword">final</span> TccTransactionContext tccTransactionContext =</div><div class="line">                      TransactionContextLocal.getInstance().get();</div><div class="line">              <span class="keyword">if</span> (Objects.nonNull(tccTransactionContext)) &#123;</div><div class="line">                <span class="comment">//dubbo rpc传参数</span></div><div class="line">                  RpcContext.getContext()</div><div class="line">                          .setAttachment(Constant.TCC_TRANSACTION_CONTEXT,</div><div class="line">                                  GsonUtils.getInstance().toJson(tccTransactionContext));</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (Objects.nonNull(tccTransactionContext)) &#123;</div><div class="line">                  <span class="keyword">if</span>(TccActionEnum.TRYING.getCode()==tccTransactionContext.getAction())&#123;</div><div class="line">                      <span class="comment">//获取协调方法</span></div><div class="line">                      String confirmMethodName = tcc.confirmMethod();</div><div class="line"></div><div class="line">                      <span class="keyword">if</span> (StringUtils.isBlank(confirmMethodName)) &#123;</div><div class="line">                          confirmMethodName = method.getName();</div><div class="line">                      &#125;</div><div class="line"></div><div class="line">                      String cancelMethodName = tcc.cancelMethod();</div><div class="line"></div><div class="line">                      <span class="keyword">if</span> (StringUtils.isBlank(cancelMethodName)) &#123;</div><div class="line">                          cancelMethodName = method.getName();</div><div class="line">                      &#125;</div><div class="line">                    <span class="comment">//设置模式</span></div><div class="line">                      <span class="keyword">final</span> TccPatternEnum pattern = tcc.pattern();</div><div class="line"></div><div class="line">                      tccTransactionManager.getCurrentTransaction().setPattern(pattern.getCode());</div><div class="line">                      TccInvocation confirmInvocation = <span class="keyword">new</span> TccInvocation(clazz,</div><div class="line">                              confirmMethodName,</div><div class="line">                              args, arguments);</div><div class="line"></div><div class="line">                      TccInvocation cancelInvocation = <span class="keyword">new</span> TccInvocation(clazz,</div><div class="line">                              cancelMethodName,</div><div class="line">                              args, arguments);</div><div class="line"></div><div class="line">                      <span class="comment">//封装调用点</span></div><div class="line">                      <span class="keyword">final</span> Participant participant = <span class="keyword">new</span> Participant(</div><div class="line">                              tccTransactionContext.getTransId(),</div><div class="line">                              confirmInvocation,</div><div class="line">                              cancelInvocation);</div><div class="line"></div><div class="line">                      tccTransactionManager.enlistParticipant(participant);</div><div class="line">                  &#125;</div><div class="line"></div><div class="line">              &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> TccRuntimeException(<span class="string">"not fount method "</span> + e.getMessage());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>springcloud 用户，则会进入 <strong>TccFeignHandler</strong> ：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TccFeignHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * logger</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(TccFeignHandler.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Target&lt;?&gt; target;</div><div class="line">    <span class="keyword">private</span> Map&lt;Method, MethodHandler&gt; handlers;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</div><div class="line">            <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> Tcc tcc = method.getAnnotation(Tcc.class);</div><div class="line">            <span class="keyword">if</span> (Objects.isNull(tcc)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.handlers.get(method).invoke(args);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> TccTransactionContext tccTransactionContext =</div><div class="line">                    TransactionContextLocal.getInstance().get();</div><div class="line">            <span class="keyword">if</span> (Objects.nonNull(tccTransactionContext)) &#123;</div><div class="line">                <span class="keyword">final</span> TccTransactionManager tccTransactionManager =</div><div class="line">                        SpringBeanUtils.getInstance().getBean(TccTransactionManager.class);</div><div class="line">                <span class="keyword">if</span> (TccActionEnum.TRYING.getCode() == tccTransactionContext.getAction()) &#123;</div><div class="line">                    <span class="comment">//获取协调方法</span></div><div class="line">                    String confirmMethodName = tcc.confirmMethod();</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (StringUtils.isBlank(confirmMethodName)) &#123;</div><div class="line">                        confirmMethodName = method.getName();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    String cancelMethodName = tcc.cancelMethod();</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (StringUtils.isBlank(cancelMethodName)) &#123;</div><div class="line">                        cancelMethodName = method.getName();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">//设置模式</span></div><div class="line">                    <span class="keyword">final</span> TccPatternEnum pattern = tcc.pattern();</div><div class="line"></div><div class="line">                    tccTransactionManager.getCurrentTransaction().setPattern(pattern.getCode());</div><div class="line"></div><div class="line">                    <span class="keyword">final</span> Class&lt;?&gt; declaringClass = method.getDeclaringClass();</div><div class="line"></div><div class="line">                    TccInvocation confirmInvocation = <span class="keyword">new</span> TccInvocation(declaringClass,</div><div class="line">                            confirmMethodName,</div><div class="line">                            method.getParameterTypes(), args);</div><div class="line"></div><div class="line">                    TccInvocation cancelInvocation = <span class="keyword">new</span> TccInvocation(declaringClass,</div><div class="line">                            cancelMethodName,</div><div class="line">                            method.getParameterTypes(), args);</div><div class="line"></div><div class="line">                    <span class="comment">//封装调用点</span></div><div class="line">                    <span class="keyword">final</span> Participant participant = <span class="keyword">new</span> Participant(</div><div class="line">                            tccTransactionContext.getTransId(),</div><div class="line">                            confirmInvocation,</div><div class="line">                            cancelInvocation);</div><div class="line"></div><div class="line">                    tccTransactionManager.enlistParticipant(participant);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.handlers.get(method).invoke(args);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTarget</span><span class="params">(Target&lt;?&gt; target)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.target = target;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHandlers</span><span class="params">(Map&lt;Method, MethodHandler&gt; handlers)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.handlers = handlers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="重要提示-在这里我们获取了在第一步设置的事务上下文，然后进行dubbo的rpc传参数，细心的你可能会发现，这里获取远端confirm，cancel方法其实就是自己本身啊？，那发起者还怎么来调用远端的confrim，cancel方法呢？这里的调用，我们通过事务上下文的状态来控制，比如在confrim阶段，我们就调用confrim方法等。。"><a href="#重要提示-在这里我们获取了在第一步设置的事务上下文，然后进行dubbo的rpc传参数，细心的你可能会发现，这里获取远端confirm，cancel方法其实就是自己本身啊？，那发起者还怎么来调用远端的confrim，cancel方法呢？这里的调用，我们通过事务上下文的状态来控制，比如在confrim阶段，我们就调用confrim方法等。。" class="headerlink" title="重要提示 在这里我们获取了在第一步设置的事务上下文，然后进行dubbo的rpc传参数，细心的你可能会发现，这里获取远端confirm，cancel方法其实就是自己本身啊？，那发起者还怎么来调用远端的confrim，cancel方法呢？这里的调用，我们通过事务上下文的状态来控制，比如在confrim阶段，我们就调用confrim方法等。。"></a>重要提示 在这里我们获取了在第一步设置的事务上下文，然后进行dubbo的rpc传参数，细心的你可能会发现，这里获取远端confirm，cancel方法其实就是自己本身啊？，那发起者还怎么来调用远端的confrim，cancel方法呢？这里的调用，我们通过事务上下文的状态来控制，比如在confrim阶段，我们就调用confrim方法等。。</h3><h2 id="到这里我们就完成了整个消费端的调用，下一篇分析提供者的调用流程！"><a href="#到这里我们就完成了整个消费端的调用，下一篇分析提供者的调用流程！" class="headerlink" title="到这里我们就完成了整个消费端的调用，下一篇分析提供者的调用流程！"></a>到这里我们就完成了整个消费端的调用，下一篇分析提供者的调用流程！</h2></div><div class="tags"></div><div class="post-nav"><a href="/2017/10/12/TCC/tcc-five/" class="pre">tcc源码解析系列(五)之项目实战</a><a href="/2017/10/12/TCC/tcc-three/" class="next">tcc源码解析系列(三)之启动详解</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yu199195.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Raincat/">Raincat</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hmily-tcc/">hmily-tcc</a><span class="category-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/14/tx/tx-two/">二阶段提交分布式事务框架源码解析系列(二)之环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/14/tx/tx-seven/">二阶段提交分布式事务框架源码解析系列之transaction-admin 事务跟踪查看管理后台</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/14/tx/tx-one/">二阶段提交分布式事务框架源码解析系列(一)之项目结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/13/tcc/tcc-seven/">tcc源码解析系列之tcc-admin事务管理后台</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/TCC/tcc-five/">tcc源码解析系列(五)之项目实战</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/TCC/tcc-four/">tcc源码解析系列(四)之项目实战</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/12/TCC/tcc-three/">tcc源码解析系列(三)之启动详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/11/TCC/tcc-two/">tcc源码解析系列(二)之环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/11/TCC/tcc-one/">tcc源码解析系列(一)之项目结构</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/yu199195" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="http://www.iocoder.cn/" title="芋道源码" target="_blank">芋道源码</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">兰陵笑笑生.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>